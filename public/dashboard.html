<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Personalized Dashboard - Career Compass</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4A90E2;
            --secondary-color: #50E3C2;
            --dark-blue: #0A2540;
            --light-gray: #f4f7fa;
            --border-color: #e6e6e6;
            --text-color: #333;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--light-gray); color: var(--text-color); }
        .dashboard-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background-color: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
        .header h1 { font-size: 28px; color: var(--dark-blue); }
        .header .user-name { color: var(--primary-color); }
        .main-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-gap: 20px; }
        .card { background-color: #fff; border-radius: 12px; padding: 25px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08); }
        .card h2 { font-size: 20px; color: var(--dark-blue); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .profile-summary { grid-column: 1 / -1; }
        .profile-summary p { font-size: 16px; line-height: 1.6; }
        .career-recommendation { text-align: center; }
        .career-recommendation .match-score { background: linear-gradient(90deg, var(--secondary-color), var(--primary-color)); color: white; padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 14px; display: inline-block; margin-bottom: 10px; }
        .career-recommendation h3 { font-size: 22px; color: var(--primary-color); margin-bottom: 10px; }
        .career-recommendation .salary { font-size: 16px; font-weight: 600; margin-bottom: 15px; }
        .career-recommendation .justification { font-size: 14px; color: #555; line-height: 1.5; }
        .skill-gap { grid-column: 1 / 3; }
        #skillGapChartContainer { position: relative; height: 300px; }
        .roadmap { grid-column: 1 / -1; }
        .roadmap-step { display: flex; align-items: flex-start; margin-bottom: 20px; }
        .roadmap-step .step-number { flex-shrink: 0; width: 40px; height: 40px; background-color: var(--primary-color); color: white; border-radius: 50%; display: grid; place-items: center; font-size: 20px; font-weight: 700; margin-right: 15px; }
        .roadmap-step .step-content h4 { font-size: 18px; margin-bottom: 5px; }
        .roadmap-step .step-content p { font-size: 14px; color: #555; margin-bottom: 10px; }
        .roadmap-step .step-content a { color: var(--primary-color); text-decoration: none; font-weight: 600; }
        @media (max-width: 992px) { .main-grid { grid-template-columns: 1fr 1fr; } .skill-gap { grid-column: 1 / -1; } }
        @media (max-width: 768px) { .header { flex-direction: column; text-align: center; } .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="header">
            <h1>Welcome to Your <span class="user-name"></span> Career Dashboard</h1>
            <a href="index.html" style="text-decoration: none; color: var(--primary-color); font-weight: 600;">‚Üê Back to Home</a>
        </header>
        <main class="main-grid">
            <section class="card profile-summary"><h2>üß† AI-Powered Profile Summary</h2><p id="profileSummaryText">Loading your profile analysis...</p></section>
            <section class="card career-recommendation" id="rec1"></section>
            <section class="card career-recommendation" id="rec2"></section>
            <section class="card career-recommendation" id="rec3"></section>
            <section class="card skill-gap"><h2>üõ†Ô∏è Skill Gap Analysis for Top Recommendation</h2><div id="skillGapChartContainer"><canvas id="skillGapChart"></canvas></div></section>
            <section class="card roadmap"><h2>üöÄ Your Personalized Learning Roadmap</h2><div id="roadmapStepsContainer"></div></section>
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('You must be logged in to view your dashboard. Redirecting...');
                window.location.href = 'login.html';
                return;
            }

            try {
                // Fetch the AI-generated data from your new backend endpoint
                const response = await fetch('http://localhost:3500/profile/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch profile data.');
                }

                const result = await response.json();
                const userData = result.data; // The user data from the backend
                
                populateDashboard(userData);

            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                document.getElementById('profileSummaryText').textContent = 'Could not load your profile data. Please try refreshing the page.';
            }
        });

        function populateDashboard(data) {
            const analysis = data.profile.aiAnalysis;
            if (!analysis) {
                 document.getElementById('profileSummaryText').textContent = 'Your AI analysis is not yet complete. Please check back later.';
                 return;
            }

            document.querySelector('.user-name').textContent = data.name + "'s";
            document.getElementById('profileSummaryText').textContent = analysis.profileSummary;
            
            analysis.topCareers.forEach((rec, index) => {
                const card = document.getElementById(`rec${index + 1}`);
                if (card) {
                    card.innerHTML = `<div class="match-score">${rec.matchScore} Match</div><h3>${rec.careerTitle}</h3><p class="justification">${rec.justification}</p>`;
                }
            });

            const roadmapContainer = document.getElementById('roadmapStepsContainer');
            roadmapContainer.innerHTML = `<h3>${analysis.learningRoadmap.introduction}</h3>`;
            analysis.learningRoadmap.steps.forEach((step, index) => {
                const stepElement = document.createElement('div');
                stepElement.className = 'roadmap-step';
                stepElement.innerHTML = `<div class="step-number">${index + 1}</div><div class="step-content"><h4>${step.stepTitle}</h4><p>${step.description}</p><a href="${step.resources[0]}" target="_blank">${step.resources[0]} ‚Üí</a></div>`;
                roadmapContainer.appendChild(stepElement);
            });

            renderSkillChart({ userSkills: data.profile.skills, requiredSkills: ["SQL", "Tableau", "Python"] }); // Example skills
        }

        function renderSkillChart(skillData) {
            const ctx = document.getElementById('skillGapChart').getContext('2d');
            const allSkills = [...new Set([...skillData.userSkills, ...skillData.requiredSkills])];
            const userSkillValues = allSkills.map(skill => skillData.userSkills.map(s => s.toLowerCase()).includes(skill.toLowerCase()) ? 5 : 0);
            const requiredSkillValues = allSkills.map(skill => skillData.requiredSkills.map(s => s.toLowerCase()).includes(skill.toLowerCase()) ? 5 : 2);
            new Chart(ctx, { type: 'radar', data: { labels: allSkills, datasets: [{ label: 'Your Skills', data: userSkillValues, backgroundColor: 'rgba(80, 227, 194, 0.2)', borderColor: 'rgba(80, 227, 194, 1)', borderWidth: 2 }, { label: 'Required Skills', data: requiredSkillValues, backgroundColor: 'rgba(74, 144, 226, 0.2)', borderColor: 'rgba(74, 144, 226, 1)', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { beginAtZero: true, max: 6, ticks: { display: false } } } } });
        }
    </script>
</body>
</html>